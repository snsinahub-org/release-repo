name: Auto release call deploy

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
       
jobs:     
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:     
      version_number: ${{ steps.semver1.outputs.version }}
    steps:
      - name: checkout
        uses: actions/checkout@v4                 
      - uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'adopt'
      - run: mvn --batch-mode --update-snapshots verify
      - run: mkdir staging && cp target/*.jar staging
      - name: get PR information
        uses: 8BitJonny/gh-get-current-pr@2.2.0
        id: PR      
      - name: 'Get semver based on pr label'
        id: semver1
        uses: "snsinahub-org/semver@v3.0.0"
        with:
          type: "${{ steps.PR.outputs.pr_labels }}"
          prefix: '' 
          body: ${{ steps.PR.outputs.pr_body }}  
          create-release: 'yes'
          prerelease: 'no'
          exit-on-missing-type: 'no'
          files: |
            target/web-app-1.1.1-SNAPSHOT.jar
      - name: 'print version'
        run: |
         echo ${{ steps.semver1.outputs.version }}
  deploy:
    needs: build
    uses: ./.github/workflows/auto-deploy.yml
    with:
      environment: dev
      release: ${{ needs.build.outputs.version_number }}

  deploy_output:
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: print deploy output
        run: echo random number generated by reusable workflow ${{ needs.deploy.outputs.random_number }}
    
    
    
 
        
